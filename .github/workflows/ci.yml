name: Continuous Integration (2025-11)
on: [push, pull_request]

# Note: Environment variables (PROJECT_NAME and vars from [tool.wads.ci.env])
# are set by the read-ci-config action in the setup job and made available
# to all subsequent jobs via GITHUB_ENV

jobs:
  # First job: Read configuration from pyproject.toml
  setup:
    name: Read Configuration
    runs-on: ubuntu-latest
    outputs:
      project-name: ${{ steps.config.outputs.project-name }}
      python-versions: ${{ steps.config.outputs.python-versions }}
      pytest-args: ${{ steps.config.outputs.pytest-args }}
      coverage-enabled: ${{ steps.config.outputs.coverage-enabled }}
      exclude-paths: ${{ steps.config.outputs.exclude-paths }}
      test-on-windows: ${{ steps.config.outputs.test-on-windows }}
      build-sdist: ${{ steps.config.outputs.build-sdist }}
      build-wheel: ${{ steps.config.outputs.build-wheel }}
      metrics-enabled: ${{ steps.config.outputs.metrics-enabled }}
      metrics-config-path: ${{ steps.config.outputs.metrics-config-path }}
      metrics-storage-branch: ${{ steps.config.outputs.metrics-storage-branch }}
      metrics-python-version: ${{ steps.config.outputs.metrics-python-version }}
      metrics-force-run: ${{ steps.config.outputs.metrics-force-run }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Read CI Config
        id: config
        uses: i2mint/wads/actions/read-ci-config@master
        with:
          pyproject-path: .

  # Second job: Validation using the config
  validation:
    name: Validation
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ${{ fromJson(needs.setup.outputs.python-versions) }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install System Dependencies
        uses: i2mint/wads/actions/install-system-deps@master
        with:
          pyproject-path: .

      - name: Install Dependencies
        uses: i2mint/wads/actions/install-deps@master
        with:
          dependency-files: pyproject.toml
          extras: dev,test

      - name: Format Source Code
        uses: i2mint/wads/actions/ruff-format@master
        with:
          line-length: 88
          target-path: .

      - name: Lint Validation
        uses: i2mint/wads/actions/ruff-lint@master
        with:
          root-dir: ${{ needs.setup.outputs.project-name }}
          output-format: github

      - name: Run Tests
        uses: i2mint/wads/actions/run-tests@master
        with:
          root-dir: ${{ needs.setup.outputs.project-name }}
          exclude: ${{ needs.setup.outputs.exclude-paths }}
          coverage: ${{ needs.setup.outputs.coverage-enabled }}
          pytest-args: ${{ needs.setup.outputs.pytest-args }}

      - name: Track Code Metrics
        if: needs.setup.outputs.metrics-enabled == 'true'
        uses: i2mint/umpyre/actions/track-metrics@master
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          config-path: ${{ needs.setup.outputs.metrics-config-path }}
          storage-branch: ${{ needs.setup.outputs.metrics-storage-branch }}
          python-version: ${{ needs.setup.outputs.metrics-python-version }}
          force-run: ${{ needs.setup.outputs.metrics-force-run }}

  # Optional Windows testing (if enabled in config)
  windows-validation:
    name: Windows Tests
    if: "!contains(github.event.head_commit.message, '[skip ci]') && needs.setup.outputs.test-on-windows == 'true'"
    needs: setup
    runs-on: windows-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ fromJson(needs.setup.outputs.python-versions)[0] }}

      - name: Install System Dependencies
        uses: i2mint/wads/actions/install-system-deps@master
        with:
          pyproject-path: .

      - name: Install Dependencies
        uses: i2mint/wads/actions/install-deps@master
        with:
          dependency-files: pyproject.toml
          extras: dev,test

      - name: Run tests
        id: test
        continue-on-error: true
        run: pytest

      - name: Report test results
        if: always()
        run: |
          if ("${{ steps.test.outcome }}" -eq "failure") {
            echo "::warning::Windows tests failed but workflow continues"
            echo "## ⚠️ Windows Tests Failed" >> $env:GITHUB_STEP_SUMMARY
            echo "Tests failed on Windows but this is informational only." >> $env:GITHUB_STEP_SUMMARY
          } else {
            echo "## ✅ Windows Tests Passed" >> $env:GITHUB_STEP_SUMMARY
          }

  # Publishing job
  publish:
    name: Publish
    if: "!contains(github.event.head_commit.message, '[skip ci]') && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')"
    needs: [setup, validation]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ fromJson(needs.setup.outputs.python-versions)[0] }}

      - name: Format Source Code
        uses: i2mint/wads/actions/ruff-format@master

      - name: Update Version Number
        id: version
        uses: i2mint/isee/actions/bump-version-number@master

      - name: Build Distribution
        uses: i2mint/wads/actions/build-dist@master
        with:
          sdist: ${{ needs.setup.outputs.build-sdist }}
          wheel: ${{ needs.setup.outputs.build-wheel }}

      - name: Publish to PyPI
        uses: i2mint/wads/actions/pypi-upload@master
        with:
          pypi-username: ${{ secrets.PYPI_USERNAME }}
          pypi-password: ${{ secrets.PYPI_PASSWORD }}
          skip-existing: false

      - name: Commit Changes
        uses: i2mint/wads/actions/git-commit@master
        with:
          commit-message: "**CI** Formatted code + Updated version to ${{ env.VERSION }} [skip ci]"
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          push: true

      - name: Tag Repository
        uses: i2mint/wads/actions/git-tag@master
        with:
          tag: ${{ env.VERSION }}
          message: "Release version ${{ env.VERSION }}"
          push: true

  # Optional GitHub Pages
  github-pages:
    name: Publish GitHub Pages
    permissions:
      contents: write
      pages: write
      id-token: write
    if: "!contains(github.event.head_commit.message, '[skip ci]') && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)"
    needs: publish
    runs-on: ubuntu-latest

    steps:
      - uses: i2mint/epythet/actions/publish-github-pages@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          ignore: "tests/,scrap/,examples/"
